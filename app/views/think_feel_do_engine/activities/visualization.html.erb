<style>
  #datepicker .ui-datepicker {
    width: 100%;
  }
</style>

<div class="btn-toolbar">
  <div class="btn-group">
    <%= link_to "Today", url_for, class: "btn btn-default" %>
    <button class="btn btn-default calendar" type="button"><i class="fa fa-calendar"></i> Day</button>
  </div>
  <div class="btn-group" id="day-range-selector">
    <button type="button" class="btn btn-default dropdown-toggle" data-toggle="dropdown" aria-expanded="false">
      <i class="fa fa-bar-chart"></i> Visualize <span class="caret"></span>
    </button>
    <ul class="dropdown-menu" role="menu">
      <li><a data-range="3" href="#">Last 3 Days</a></li>
      <li><a data-range="7" href="#">Last 7 Days</a></li>
    </ul>
  </div>
</div>

<div id="do-viz-wrapper">
  <section id="activities-chart"></section>
</div>

<div id="datepicker" style="display: none;margin: 0 0 10px;"></div>

<div id="activities">
  <div class="panel panel-default">
    <div class="panel-heading">
      <h3 class="panel-title">
        Daily Averages for <%= formatted_date %>
      </h3>
    </div>
    <ul class="list-group">
      <li class="list-group-item">
        <strong class="text-muted">Mood:</strong>
        <span class="pull-right"><%= moods.empty? ? "No Recordings" : moods.all.map(&:rating).reduce(:+).to_f / moods.count %></span>
      </li>
      <li class="list-group-item">
        <strong class="text-muted">Positive Emotions:</strong>
        <span class="pull-right"><%= positive_emotions.empty? ? "No Recordings" : positive_emotions.all.map(&:rating).reduce(:+).to_f / positive_emotions.count %></span>
      </li>
      <li class="list-group-item">
        <strong class="text-muted">Negative Emotions:</strong>
        <span class="pull-right"><%= negative_emotions.empty? ? "No Recordings" : negative_emotions.all.map(&:rating).reduce(:+).to_f / negative_emotions.count %></span>
      </li>
    </ul>
  </div>

  <% if activities.empty? %>

    <div class="alert alert-info" role="alert">
      <strong>Notice!</strong> No activities were completed during this day.
    </div>

  <% else %>

    <div class="panel-group" id="accordion" role="tablist" aria-multiselectable="true">
      <div class="panel panel-default">
        <div class="panel-heading" role="tab" id="activity-summary">
          <h4 class="panel-title">
            <a data-toggle="collapse" data-parent="#accordion" href="#collapse-activity-summary" aria-expanded="true" aria-controls="collapse-activity-summary">
              Daily Summaries
            </a>
          </h4>
        </div>
        <div id="collapse-activity-summary" class="panel-collapse collapse" role="tabpanel" aria-labelledby="activity-summary">
          <div class="panel-body">
            <p>
              You spent
              <%= pluralize(activities.pleasurable.count, 'hour') %>
              engaged in pleasurable activities and
              <%= pluralize(activities.accomplished.count, 'hour') %>
              engaged in accomplished activities.
            </p>
            <p>
              <%= pluralize(activities.pleasurable.map(&:id).uniq.count, 'activity').capitalize %>
              you recorded as high pleasure, while
              <%= pluralize(activities.accomplished.map(&:id).uniq.count, 'activity') %>
              you recorded as high accomplishment, and
              <%= pluralize(activities.pleasurable.accomplished.map(&:id).uniq.count, 'activity') %>
              you recorded is both high pleasure and high accomplishment.
            </p>
            <p>
              Completion Score:
              <%= (activities.completed.count.to_f / activities.count * 100).round %>%
              (You completed <%= activities.completed.count %> out of <%= pluralize(activities.count, 'activity') %> that you scheduled.)
            <p>
            <p>
              <strong>Average Accomplishment Discrepancy:</strong> <%= average_intensity_difference(activities.completed, :accomplishment) %>
            </p>
            </p>
              <strong>Average Pleasure Discrepancy:</strong> <%= average_intensity_difference(activities.completed, :pleasure) %>
            </p>
          </div>
        </div>
      </div>

      <% activities.each do |activity| %>

        <div class="panel panel-default">

          <div class="panel-heading" role="tab" id="activity-<%= activity.id %>">
            <h4 class="panel-title">
              <a data-toggle="collapse" data-parent="#accordion" href="#collapse-activity-<%= activity.id %>" aria-expanded="true" aria-controls="collapse-activity-<%= activity.id %>">
                <% if activity.start_time %>
                  <%= activity.start_time.strftime("%l %P") %>
                  -
                  <%= activity.end_time.strftime("%l %P") %>:
                  <%= activity.title %>
                <% end %>
              </a>
              <p class="list-group-item-text small" style="margin-top: 5px;">
                <%= "Accomplishment: #{activity.actual_accomplishment_intensity}" if activity.actual_accomplishment_intensity %>
                <%= "&middot;".html_safe if activity.actual_accomplishment_intensity && activity.actual_pleasure_intensity %>
                <%= "Pleasure: #{activity.actual_pleasure_intensity}" if activity.actual_pleasure_intensity %>
              </p>
            </h4>
          </div>

          <div id="collapse-activity-<%= activity.id %>" class="panel-collapse collapse" role="tabpanel" aria-labelledby="activity-<%= activity.id %>">

            <%= form_for activity, url: participants_activity_path(activity), remote: true do |f| %>
                <table class="table">
                  <thead>
                    <tr>
                      <th></th>
                      <th>Accomplishment</th>
                      <th>Pleasure</th>
                    </tr>
                  </thead>
                  <tbody>
                    <tr>
                      <td>Predicted</td>
                      <td><%= activity.predicted_accomplishment_value %>: <%= activity.predicted_accomplishment_intensity %></td>
                      <td><%= activity.predicted_pleasure_value %>: <%= activity.predicted_pleasure_intensity %></td>
                    </tr>
                    <tr>
                      <td>Actual</td>
                      <td><%= activity.actual_accomplishment_value %>: <%= activity.actual_accomplishment_intensity %></td>
                      <td><%= activity.actual_pleasure_value %>: <%= activity.actual_pleasure_intensity %></td>
                    </tr>
                    <tr>
                      <td>Difference</td>
                      <td><%= activity.intensity_difference(:accomplishment) %></td>
                      <td><%= activity.intensity_difference(:pleasure) %></td>
                    </tr>
                    </tbody>
                </table>
              <div class="panel-body" style="display: none;">
                <div class="form-group">
                  <%= f.label :actual_accomplishment_intensity %>
                  <%= f.select :actual_accomplishment_intensity, (0..10).to_a, {}, class: "form-control" %>
                </div>
                <div class="form-group">
                  <%= f.label :actual_pleasure_intensity %>
                  <%= f.select :actual_pleasure_intensity, (0..10).to_a, {}, class: "form-control" %>
                </div>
              </div>

              <div class="panel-footer">
                <%= f.submit "Update", class: "btn btn-primary", style: "display: none;" %>
                <button type="button" class="btn btn-default show-table" data-target="#edit_activity_<%= activity.id %>" style="display: none;">Cancel</button>
                <button type="button" class="btn btn-default show-form" data-target="#edit_activity_<%= activity.id %>">
                  Edit
                </button>
              </div>
            <% end %>
          </div>
        </div>
      <% end %>
    </div>

  <% end %>

  <div class="btn-toolbar">
    <%= link_to "Previous Day", "?date=#{local_time.advance(days: -1).strftime("%d/%m/%Y")}", class: "btn btn-default" %>
    <%= link_to "Next Day", "?date=#{local_time.advance(days: 1).strftime("%d/%m/%Y")}", class: "btn btn-default pull-right" %>
  </div>
</div>

<script type="text/javascript">
  $(document).on('ready, page:change', function() {
    $("#datepicker").datepicker({
      onSelect: function(dateText, inst) {
        var date, formattedDate;

        date = new Date(dateText);
        formattedDate = date.getDate() + "/" + (parseInt(date.getMonth()) + 1) + "/" + date.getFullYear();
        Turbolinks.visit(window.location.pathname + "?date=" + formattedDate);
      }
    });
    $("button.calendar").on("click", function(event) {
      $("div#datepicker").show();
      $("#activities-chart").children().remove()
    });
    $("button.show-form").on("click", function(event) {
      var target;

      target = $(event.currentTarget).data("target");
      $(target).find("button.show-form, table.table").hide();
      $(target).find("button.show-table, div.panel-body, input").show();
    });
    $("button.show-table").on("click", function(event) {
      var target;

      target = $(event.currentTarget).data("target");
      $(target).find("button.show-table, div.panel-body, input").hide();
      $(target).find("button.show-form, table.table").show();
    });

    $("#day-range-selector li a").on("click", function(event) {
      var numOfDays;

      $("#activities").remove();
      $("#datepicker").hide();
      numOfDays = $(event.currentTarget).data("range");
      dailyBreakdown(<%= completed_week_activities.to_json(methods: :title).html_safe %>, numOfDays);
    })
  });
</script>